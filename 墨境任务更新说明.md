# 墨境任务系统功能更新

## 更新日期
2025年12月15日

## 功能需求
墨境系统任务页面需要：
1. 显示当日任务（共6个，未完成的和已完成的都显示）
2. 显示所有已完成的任务
3. 已完成的任务支持再次练习
4. 可以查看每次练习的结果和评审记录

## 实现内容

### 后端更新

#### 1. 新增服务函数 (server/services/inkTaskService.js)

**getCompletedTasks(options)**
- 获取所有已完成的任务列表
- 支持按任务类型、属性类型筛选
- 支持分页
- 返回每个任务的练习次数、最高分、最后练习时间

**getTaskPracticeHistory(taskId)**
- 获取某个任务的所有练习记录
- 包含每次练习的内容、分数、AI评审等完整信息
- 返回总练习次数、完成次数、最高分等统计

**restartCompletedTask(taskId)**
- 为已完成的任务创建新的练习记录
- 验证任务是否已完成过
- 返回新的练习记录，标识为再练习

#### 2. 新增API路由 (server/routes/mojing.js)

**GET /mojing/tasks/completed**
- 获取所有已完成任务
- 查询参数：limit, offset, taskType, attrType
- 返回：任务列表、总数、分页信息

**GET /mojing/tasks/:id/history**
- 获取指定任务的练习历史记录
- 返回：任务信息、所有练习记录、统计数据

**POST /mojing/tasks/:id/practice**
- 开始再次练习已完成的任务
- 返回：新的练习记录、任务信息

#### 3. 修改现有API (server/routes/mojing.js)

**GET /mojing/tasks/today**
- 添加 showCompleted 参数（默认true）
- 返回当日所有任务（包括已完成和未完成）
- 未完成任务限制为3墨点+3墨线（共6个）
- 已完成任务全部显示
- 添加 summary 字段：total, completed, pending

### 前端更新

#### 1. 新增API函数 (client/src/api/mojing.js)

```javascript
getCompletedTasks(params)      // 获取已完成任务
getTaskPracticeHistory(taskId)  // 获取任务历史
practiceTask(taskId)            // 再次练习
```

#### 2. 更新任务列表页面 (client/src/views/MoJing/Tasks.vue)

**新增功能：**
- 视图切换：今日任务 / 已完成任务
- 已完成任务列表：
  - 显示练习次数
  - 显示最高分
  - 显示最后练习时间
  - 筛选器：任务类型、属性类型
  - 支持分页加载
- 任务历史对话框：
  - 显示所有练习记录
  - 每条记录包含：日期、分数、内容预览、耗时
  - 可展开查看详细AI评审
- 再次练习按钮：点击后创建新练习并跳转

**UI优化：**
- 今日统计卡片显示完成进度
- 已完成任务卡片样式区分
- 历史记录时间友好显示（今天、昨天、X天前）

#### 3. TaskDetail页面兼容性
- 无需修改，已支持加载新的练习记录
- 自动处理再练习场景

## 数据库支持

使用现有表结构，无需修改：
- `mojing_daily_tasks` - 任务表
- `mojing_task_records` - 练习记录表

## 使用流程

### 查看今日任务
1. 打开任务页面，默认显示"今日任务"视图
2. 显示未完成任务（最多6个）+ 所有已完成任务
3. 点击任务卡片进入练习页面

### 查看已完成任务
1. 切换到"已完成"标签
2. 浏览所有历史完成的任务
3. 可按任务类型、属性类型筛选
4. 滚动到底部自动加载更多

### 再次练习
1. 在已完成任务列表中，点击"再次练习"按钮
2. 确认后创建新的练习记录
3. 自动跳转到任务详情页开始练习

### 查看练习历史
1. 在已完成任务列表中，点击任务卡片
2. 弹出历史记录对话框
3. 查看所有练习记录和评审详情

## 技术要点

### 后端
- 使用 JOIN 查询获取任务练习统计
- 分页查询优化大数据量加载
- 记录状态验证：确保只有已完成的任务才能再练习

### 前端
- 响应式设计，适配移动端
- 懒加载：已完成任务支持无限滚动
- 时间格式化：友好显示相对时间
- 弹窗组件：展示详细历史记录

## 测试建议

1. **今日任务显示**
   - 完成几个任务后，确认已完成和未完成任务都显示
   - 确认最多显示6个未完成任务

2. **已完成任务列表**
   - 切换到已完成视图
   - 测试筛选功能
   - 测试分页加载

3. **再次练习**
   - 点击已完成任务的"再次练习"
   - 确认创建新的练习记录
   - 完成新练习，确认两次记录都保存

4. **练习历史**
   - 对同一任务练习多次
   - 查看历史记录，确认所有记录都显示
   - 确认AI评审可以正常展开查看

## 备注

- 备份文件：`server/routes/mojing.js.backup`, `client/src/views/MoJing/Tasks_old.vue`
- 可在测试完成后删除备份文件
